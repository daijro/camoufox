name: Lucid Production Build (Phase 4/5)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: # Manual trigger enabled

jobs:
  prepare-source:
    name: Prepare Camoufox Source (Linux)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install prerequisites
        run: |
          sudo apt-get update -y
          sudo apt-get install -y aria2 p7zip-full python3 python3-pip

      - name: Run multibuild bootstrap (Linux)
        run: |
          python3 -u multibuild.py --bootstrap --target windows --arch x86_64 > multibuild_prepare.log 2>&1 || true
          ls -la

      - name: Archive camoufox-* directory
        run: |
          if ls camoufox-* 1> /dev/null 2>&1; then
            tar -cJf camoufox-source.tar.xz camoufox-*
          else
            echo "No camoufox-* directory found; failing prepare job"; exit 1
          fi

      - name: Upload camoufox source artifact
        uses: actions/upload-artifact@v4
        with:
          name: camoufox-source
          path: camoufox-source.tar.xz

  build:
    name: Build Camoufox Windows
    needs: prepare-source
    runs-on: windows-2022 # Upgraded from windows-2019 for runner availability

    env:
      MOZILLABUILD: C:\mozilla-build
      MOZ_OBJDIR: obj-lucid-release
      MACH_NO_INTERACTIVE: 1
      PYTHONUTF8: 1
      MOZ_ILL_BUILD_TOOLS: 1

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install Prerequisite Tools
        shell: powershell
        run: |
          choco install make aria2 7zip wget msitools -y --no-progress

      - name: Install MozillaBuild 4.4
        shell: powershell
        run: |
          choco install mozillabuild --version=4.4.0 -y --no-progress

      - name: Windows Preflight Check
        shell: powershell
        run: |
          Write-Host "Running Windows preflight checks..."
          if (-not (Test-Path 'C:\mozilla-build\start-shell.bat')) {
            Write-Host "ERROR: mozillabuild start-shell not found at C:\mozilla-build\start-shell.bat. Ensure mozillabuild installed via Chocolatey or preinstalled on runner.";
            exit 1
          }
          $out = & 'C:\mozilla-build\start-shell.bat' -c "echo START_SHELL_OK" 2>&1
          if ($out -notmatch 'START_SHELL_OK') { Write-Host "ERROR: start-shell execution failed: $out"; exit 1 }
          Write-Host "Start-shell sanity check: OK"

      - name: Configure Git Identity
        shell: powershell
        run: |
          git config --global user.email "ci-bot@lucid.empire"
          git config --global user.name "Lucid Builder"

      - name: Start-Shell Pre-Bootstrap Diagnostic
        shell: cmd
        run: |
          echo "STARTING START-SHELL DIAGNOSTIC..."
          call "C:\mozilla-build\start-shell.bat" -c "echo PATH: $PATH; which aria2c || echo 'aria2c MISSING'; which make || echo 'make MISSING'; which 7z || echo '7z MISSING'; python3 --version || echo 'python3 MISSING'; make -n bootstrap" > multibuild_dryrun.log 2>&1

      - name: Attempt Direct Multibuild (runner)
        if: runner.os != 'Windows'
        continue-on-error: true
        shell: cmd
        run: |
          echo "ATTEMPT: Direct multibuild on runner (captures output to multibuild_download_direct.log)"
          python -u multibuild.py --bootstrap --target windows --arch x86_64 > multibuild_download_direct.log 2>&1 || echo "DIRECT_RUN_FAILED" >> multibuild_download_direct.log || true

      - name: Start-shell Multibuild Dry-run (inspect for unsafe commands)
        continue-on-error: false
        shell: cmd
        run: |
          echo "ATTEMPT: Dry-run multibuild inside start-shell (captures output to multibuild_dryrun.log)"
          call "C:\mozilla-build\start-shell.bat" -c "python -u multibuild.py --bootstrap --target windows --arch x86_64 --dry-run" > multibuild_dryrun.log 2>&1 || echo "DRYRUN_FAILED" >> multibuild_dryrun.log || true

      - name: Inspect Dry-run for Linux package manager calls
        shell: cmd
        run: |
          echo "Checking dry-run for apt/dnf/pacman/sudo usage..."
          type multibuild_dryrun.log || echo "(no dryrun log)"
          findstr /R /C:"apt-get" /C:"dnf" /C:"pacman" /C:"sudo" multibuild_dryrun.log > dryrun_unsafe.txt || echo "No matches"
          if exist dryrun_unsafe.txt (
            echo "ERROR: Dry-run included Linux-only package commands or sudo. See multibuild_dryrun.log" 
            type dryrun_unsafe.txt
            exit 1
          ) else (
            echo "Dry-run looks safe for Windows (no Linux package commands found)."
          )

      - name: Download prepared camoufox source artifact
        uses: actions/download-artifact@v4
        with:
          name: camoufox-source
          path: .

      - name: Extract camoufox source artifact (if present)
        shell: powershell
        run: |
          if (Test-Path camoufox-source.tar.xz) {
            Write-Host "Extracting camoufox-source.tar.xz..."
            tar -xJf camoufox-source.tar.xz
            Write-Host "Source extraction complete.";
          } else {
            Write-Host "No prepared source artifact found; falling back to multibuild bootstrap";
          }

      - name: Attempt Start-Shell Multibuild (internal logging)
        continue-on-error: true
        shell: cmd
        run: |
          echo "ATTEMPT: multibuild inside start-shell (captures output to multibuild_inner.log)"
          call "C:\mozilla-build\start-shell.bat" -c "python -u multibuild.py --bootstrap --target windows --arch x86_64" > multibuild_inner.log 2>&1 || echo "START_SHELL_FAILED" >> multibuild_inner.log || true
      - name: Dump Multibuild & Mach Logs (for diagnostics)
        shell: cmd
        run: |
          echo "--- multibuild_download_direct.log ---"
          type multibuild_download_direct.log || echo "(no direct log)"
          echo "--- multibuild_inner.log ---"
          type multibuild_inner.log || echo "(no inner log)"
          echo "--- multibuild_bootstrap_inner.log ---"
          type multibuild_bootstrap_inner.log || echo "(no bootstrap inner log)"
          echo "--- multibuild_dryrun.log ---"
          type multibuild_dryrun.log || echo "(no dryrun log)"
          echo "--- choco_mozillabuild_install.log ---"
          type choco_mozillabuild_install.log || echo "(no choco log)"
      - name: Inject Sovereign Code
        shell: powershell
        run: |
          # Try top-level first, then search recursively
          $SourceDir = Get-ChildItem -Directory "camoufox-*" -ErrorAction SilentlyContinue | Select-Object -First 1 -ExpandProperty Name
          if (-not $SourceDir) {
            $recursive = Get-ChildItem -Recurse -Directory -ErrorAction SilentlyContinue | Where-Object { $_.Name -like 'camoufox-*' } | Select-Object -First 1
            if ($recursive) { $SourceDir = $recursive.FullName }
          }

          if (-not $SourceDir) {
            Write-Error "Source code not found! multibuild.py setup or bootstrap may have failed."
            Write-Host "Listing workspace top-level (limited):"
            Get-ChildItem -Force | Select-Object -First 200 | Format-Table -AutoSize
            Write-Host "Looking for camoufox-* recursively (depth unlimited):"
            Get-ChildItem -Recurse -Directory -ErrorAction SilentlyContinue | Where-Object { $_.Name -like 'camoufox-*' } | Format-Table -AutoSize
            if (Test-Path multibuild_download_direct.log) { Get-Content multibuild_download_direct.log -Raw } else { Write-Host "No multibuild_download_direct.log found" }
            if (Test-Path multibuild_inner.log) { Get-Content multibuild_inner.log -Raw } else { Write-Host "No multibuild_inner.log found" }
            if (Test-Path multibuild_bootstrap.log) { Get-Content multibuild_bootstrap.log -Raw } else { Write-Host "No multibuild_bootstrap.log found" }
            exit 1
          }

          Write-Host "Targeting Source: $SourceDir"
          $TargetDir = "$SourceDir/python/mozbuild/mozbuild"
          if (Test-Path "core/genesis_engine.py") { Copy-Item "core/genesis_engine.py" -Destination $TargetDir -Force; Write-Host "Genesis Engine: INJECTED" }
          if (Test-Path "modules/commerce_injector.py") { Copy-Item "modules/commerce_injector.py" -Destination $TargetDir -Force; Write-Host "Commerce Injector: INJECTED" }
          if (Test-Path "modules/humanization.py") { Copy-Item "modules/humanization.py" -Destination $TargetDir -Force; Write-Host "Biometric Engine: INJECTED" }

      - name: Bootstrap Dependencies
        shell: cmd
        run: |
          cd camoufox-*
          call "C:\mozilla-build\start-shell.bat" -c "./mach bootstrap --application-choice=browser --no-interactive" > multibuild_bootstrap.log 2>&1

      - name: "Debug: Post-bootstrap workspace & multibuild logs"
        shell: powershell
        run: |
          Set-Location -Path "$(Get-ChildItem -Directory 'camoufox-*' | Select-Object -First 1 -ExpandProperty Name)"
          Write-Host "Listing source dir contents (limited):"
          Get-ChildItem -Force | Select-Object -First 200 | Format-Table -AutoSize

          Write-Host "Mach bootstrap tail (if present):"
          if (Test-Path ..\multibuild_bootstrap.log) { Get-Content ..\multibuild_bootstrap.log -Tail 200 } else { Write-Host "No multibuild_bootstrap.log found in workspace root" }

      - name: Write MozConfig
        shell: cmd
        run: |
          cd camoufox-*
          echo Configuring Build Options...
          call "C:\mozilla-build\start-shell.bat" -c "echo 'ac_add_options --target=x86_64-pc-windows-msvc' >> .mozconfig"
          call "C:\mozilla-build\start-shell.bat" -c "echo 'ac_add_options --disable-crashreporter' >> .mozconfig"
          call "C:\mozilla-build\start-shell.bat" -c "echo 'ac_add_options --disable-updater' >> .mozconfig"
          call "C:\mozilla-build\start-shell.bat" -c "echo 'ac_add_options --disable-tests' >> .mozconfig"
          call "C:\mozilla-build\start-shell.bat" -c "echo 'ac_add_options --disable-debug' >> .mozconfig"
          call "C:\mozilla-build\start-shell.bat" -c "echo 'ac_add_options --enable-optimize' >> .mozconfig"

      - name: Compile Binary
        shell: cmd
        timeout-minutes: 360
        run: |
          cd camoufox-*
          call "C:\mozilla-build\start-shell.bat" -c "./mach build"

      - name: Package & Upload
        shell: cmd
        run: |
          cd camoufox-*
          call "C:\mozilla-build\start-shell.bat" -c "./mach package"

      - name: Verify Packages
        shell: powershell
        run: |
          $zips = Get-ChildItem -Path "camoufox-*/obj-*/dist/install/sea/*.zip" -File -ErrorAction SilentlyContinue
          if (-not $zips) {
            Write-Host "ERROR: No packaged installers found at camoufox-*/obj-*/dist/install/sea/*.zip"
            Write-Host "Dumping diagnostic logs for review..."
            if (Test-Path ..\multibuild_download_direct.log) { Get-Content ..\multibuild_download_direct.log -Raw } else { Write-Host "No multibuild_download_direct.log found" }
            if (Test-Path ..\multibuild_inner.log) { Get-Content ..\multibuild_inner.log -Raw } else { Write-Host "No multibuild_inner.log found" }
            if (Test-Path ..\multibuild_bootstrap.log) { Get-Content ..\multibuild_bootstrap.log -Raw } else { Write-Host "No multibuild_bootstrap.log found" }
            exit 1
          } else {
            Write-Host "Found packaged installers: $($zips.Name -join ', ')"
          }

      - name: Upload Build Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lucid-build-logs
          path: |
            multibuild_download_direct.log
            multibuild_inner.log
            multibuild_bootstrap.log
            choco_mozillabuild_install.log
          if-no-files-found: warn

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: lucid-empire-release
          path: camoufox-*/obj-*/dist/install/sea/*.zip
          retention-days: 5
          if-no-files-found: error
