name: Lucid Production Build (Phase 4/5)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: # Manual trigger enabled

jobs:
  build:
    name: Build Camoufox Windows
    runs-on: windows-2022 # Upgraded from windows-2019 for runner availability

    env:
      MOZILLABUILD: C:\mozilla-build
      MOZ_OBJDIR: obj-lucid-release
      MACH_NO_INTERACTIVE: 1
      PYTHONUTF8: 1
      MOZ_ILL_BUILD_TOOLS: 1

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install Prerequisite Tools
        shell: powershell
        run: |
          choco install make aria2 7zip wget msitools -y --no-progress

      - name: Install MozillaBuild 4.4
        shell: powershell
        run: |
          choco install mozillabuild --version=4.4.0 -y --no-progress

      - name: Configure Git Identity
        shell: powershell
        run: |
          git config --global user.email "ci-bot@lucid.empire"
          git config --global user.name "Lucid Builder"

      - name: Start-Shell Pre-Bootstrap Diagnostic
        shell: cmd
        run: |
          echo "STARTING START-SHELL DIAGNOSTIC..."
          call "C:\mozilla-build\start-shell.bat" -c "echo PATH: $PATH; which aria2c || echo 'aria2c MISSING'; which make || echo 'make MISSING'; which 7z || echo '7z MISSING'; python3 --version || echo 'python3 MISSING'; make -n bootstrap" > multibuild_dryrun.log 2>&1

      - name: Attempt Direct Multibuild (runner)
        shell: cmd
        run: |
          echo "ATTEMPT: Direct multibuild on runner (captures output to multibuild_download_direct.log)"
          python3 multibuild.py --bootstrap --target windows --arch x86_64 > multibuild_download_direct.log 2>&1 || echo "DIRECT_RUN_FAILED" >> multibuild_download_direct.log

      - name: Attempt Start-Shell Multibuild (internal logging)
        shell: cmd
        run: |
          echo "ATTEMPT: multibuild inside start-shell (internal redirection to multibuild_inner.log)"
          call "C:\mozilla-build\start-shell.bat" -c "python3 multibuild.py --bootstrap --target windows --arch x86_64 > multibuild_inner.log 2>&1" || echo "START_SHELL_FAILED" >> multibuild_inner.log

      - name: Inject Sovereign Code
        shell: powershell
        run: |
          $SourceDir = Get-ChildItem -Directory "camoufox-*" | Select-Object -First 1 -ExpandProperty Name
          if (-not $SourceDir) { Write-Error "Source code not found! multibuild.py failed." }
          Write-Host "Targeting Source: $SourceDir"
          $TargetDir = "$SourceDir/python/mozbuild/mozbuild"
          if (Test-Path "core/genesis_engine.py") { Copy-Item "core/genesis_engine.py" -Destination $TargetDir -Force; Write-Host "Genesis Engine: INJECTED" }
          if (Test-Path "modules/commerce_injector.py") { Copy-Item "modules/commerce_injector.py" -Destination $TargetDir -Force; Write-Host "Commerce Injector: INJECTED" }
          if (Test-Path "modules/humanization.py") { Copy-Item "modules/humanization.py" -Destination $TargetDir -Force; Write-Host "Biometric Engine: INJECTED" }

      - name: Bootstrap Dependencies
        shell: cmd
        run: |
          cd camoufox-*
          call "C:\mozilla-build\start-shell.bat" -c "./mach bootstrap --application-choice=browser --no-interactive" > multibuild_bootstrap.log 2>&1

      - name: "Debug: Post-bootstrap workspace & multibuild logs"
        shell: powershell
        run: |
          Set-Location -Path "$(Get-ChildItem -Directory 'camoufox-*' | Select-Object -First 1 -ExpandProperty Name)"
          Write-Host "Listing source dir contents (limited):"
          Get-ChildItem -Force | Select-Object -First 200 | Format-Table -AutoSize

          Write-Host "Mach bootstrap tail (if present):"
          if (Test-Path ..\multibuild_bootstrap.log) { Get-Content ..\multibuild_bootstrap.log -Tail 200 } else { Write-Host "No multibuild_bootstrap.log found in workspace root" }

      - name: Write MozConfig
        shell: cmd
        run: |
          cd camoufox-*
          echo Configuring Build Options...
          call "C:\mozilla-build\start-shell.bat" -c "echo 'ac_add_options --target=x86_64-pc-windows-msvc' >> .mozconfig"
          call "C:\mozilla-build\start-shell.bat" -c "echo 'ac_add_options --disable-crashreporter' >> .mozconfig"
          call "C:\mozilla-build\start-shell.bat" -c "echo 'ac_add_options --disable-updater' >> .mozconfig"
          call "C:\mozilla-build\start-shell.bat" -c "echo 'ac_add_options --disable-tests' >> .mozconfig"
          call "C:\mozilla-build\start-shell.bat" -c "echo 'ac_add_options --disable-debug' >> .mozconfig"
          call "C:\mozilla-build\start-shell.bat" -c "echo 'ac_add_options --enable-optimize' >> .mozconfig"

      - name: Compile Binary
        shell: cmd
        timeout-minutes: 360
        run: |
          cd camoufox-*
          call "C:\mozilla-build\start-shell.bat" -c "./mach build"

      - name: Package & Upload
        shell: cmd
        run: |
          cd camoufox-*
          call "C:\mozilla-build\start-shell.bat" -c "./mach package"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: lucid-empire-release
          path: camoufox-*/obj-*/dist/install/sea/*.zip
          retention-days: 5
          if-no-files-found: error
