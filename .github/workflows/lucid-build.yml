name: Lucid Windows Native Build
on: [push, workflow_dispatch]

jobs:
  build:
    name: Build Camoufox (Windows MSVC)
    runs-on: windows-2022 # Upgraded from windows-2019 for runner availability
    
    env:
      MOZILLABUILD: C:\mozilla-build
      MOZ_OBJDIR: obj-lucid-release
      MACH_NO_INTERACTIVE: 1
      PYTHONUTF8: 1
      MOZ_ILL_BUILD_TOOLS: 1

    steps:
      # 1. CHECKOUT REPOSITORY
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      # DEBUG: List workspace to assist with transient failures
      - name: "Debug: Workspace contents"
        shell: powershell
        run: |
          Write-Host "Listing top-level workspace entries (limited)..."
          Get-ChildItem -Force | Select-Object -First 200 | Format-Table -AutoSize

      # 2. INSTALL SYSTEM PREREQUISITES (CRITICAL FIX)
      # Installs the tools that 'mach bootstrap' expects but are missing on the runner
      - name: Install Prerequisite Tools
        shell: powershell
        run: |
          # Enable verbose PS debug if CI wants extra traces. Set CI_CHOCOLATEY_DEBUG=1 to enable.
          if ($env:CI_CHOCOLATEY_DEBUG -eq '1') { Set-PSDebug -Trace 1 } else { Set-PSDebug -Trace 0 }
          choco install make aria2 7zip wget -y --no-progress
          Write-Host "msitools package is unavailable on Windows runners; skipping install."

      # 3. INSTALL MOZILLA BUILD ENVIRONMENT (retries + debug logs)
      - name: Install MozillaBuild 4.4
        shell: pwsh
        run: |
          Write-Host "Chocolatey version:"; choco --version
          Write-Host "Searching for mozillabuild package..."
          $search = choco search mozillabuild -s https://community.chocolatey.org/api/v2/ || Write-Host "choco search returned no results"
          Write-Host $search

          # Detect available versions and prefer pinned 4.4.0, fallback to latest found.
          $targetVersion = "4.4.0"
          if ($search -and ($search -match '(\d+\.\d+\.\d+)')) {
            $matches = [regex]::Matches($search, '(\d+\.\d+\.\d+)')
            $latest = $matches[$matches.Count - 1].Groups[1].Value
            if ($latest) {
              Write-Host "Detected available mozillabuild version: $latest"
              $targetVersion = $latest
            }
          } else {
            Write-Host "No versions detected in search results; will try pinned version $targetVersion first."
          }

          $installed = $false
          for ($i=1; $i -le 3; $i++) {
            Write-Host "Attempt #${i}: installing mozillabuild ($targetVersion)"
            try {
              choco install mozillabuild --version=$targetVersion -y --no-progress --debug -s https://community.chocolatey.org/api/v2/ | Tee-Object -FilePath choco_mozillabuild_install.log
              $installed = $true
              break
            } catch {
              Write-Host "Attempt #${i} failed: $_"
              Get-Content choco_mozillabuild_install.log -Tail 200 2>$null
              Start-Sleep -Seconds (5 * $i)
            }
          }

          if (-not $installed) {
            Write-Host "Versioned install failed; trying unversioned install"
            try {
              choco install mozillabuild -y --no-progress --debug -s https://community.chocolatey.org/api/v2/ | Tee-Object -FilePath choco_mozillabuild_install.log
              $installed = $true
            } catch {
              Write-Host "Unversioned install failed: $_"
              if (Test-Path choco_mozillabuild_install.log) { Get-Content choco_mozillabuild_install.log -Tail 200 }
            }
          }

          if (-not $installed) {
            Write-Host "ERROR: mozillabuild could not be installed via Chocolatey."
            Write-Host "choco search mozillabuild output:"; choco search mozillabuild -s https://community.chocolatey.org/api/v2/ || true
            Write-Host "Listing local packages:"; choco list --local-only || true
            Write-Host "Contents of choco_mozillabuild_install.log:"; if (Test-Path choco_mozillabuild_install.log) { Get-Content choco_mozillabuild_install.log -Tail 200 } else { Write-Host "No choco log found" }
            exit 1
          }
          Write-Host "mozillabuild installed successfully."
      
      # 4. CONFIGURE GIT IDENTITY (Required for Patching)
      - name: Configure Git Identity
        shell: powershell
        run: |
          git config --global user.email "ci-bot@lucid.empire"
          git config --global user.name "Lucid Builder"

      # 5. DOWNLOAD FIREFOX SOURCE (multibuild setup)
      - name: Attempt Direct Multibuild (runner)
        if: runner.os != 'Windows'
        continue-on-error: true
        shell: cmd
        run: |
          echo "ATTEMPT: Direct multibuild on runner (captures output to multibuild_download_direct.log)"
          python -u multibuild.py --bootstrap --target windows --arch x86_64 > multibuild_download_direct.log 2>&1 || echo "DIRECT_RUN_FAILED" >> multibuild_download_direct.log || true

      - name: Attempt Start-Shell Multibuild (internal logging)
        continue-on-error: true
        shell: cmd
        run: |
          echo "ATTEMPT: multibuild inside start-shell (internal redirection to multibuild_inner.log)"
          call "C:\mozilla-build\start-shell.bat" -c "python -u multibuild.py --bootstrap --target windows --arch x86_64 > multibuild_inner.log 2>&1" || echo "START_SHELL_FAILED" >> multibuild_inner.log || true

      # 6. BOOTSTRAP SOURCE (Fetches the Firefox code)
      - name: Attempt Start-Shell Mach Bootstrap (internal logging)
        continue-on-error: true
        shell: cmd
        run: |
          echo "ATTEMPT: mach bootstrap inside start-shell (internal redirection to multibuild_bootstrap_inner.log)"
          call "C:\mozilla-build\start-shell.bat" -c "./mach bootstrap --application-choice=browser --no-interactive > multibuild_bootstrap_inner.log 2>&1" || echo "MACH_BOOTSTRAP_FAILED" >> multibuild_bootstrap_inner.log || true

      - name: Dump Multibuild & Mach Logs (for diagnostics)
        shell: cmd
        run: |
          echo "--- multibuild_download_direct.log ---"
          type multibuild_download_direct.log || echo "(no direct log)"
          echo "--- multibuild_inner.log ---"
          type multibuild_inner.log || echo "(no inner log)"
          echo "--- multibuild_bootstrap_inner.log ---"
          type multibuild_bootstrap_inner.log || echo "(no bootstrap inner log)"
          echo "--- multibuild_dryrun.log ---"
          type multibuild_dryrun.log || echo "(no dryrun log)"
          echo "--- choco_mozillabuild_install.log ---"
          type choco_mozillabuild_install.log || echo "(no choco log)"
      # DEBUG: Post-bootstrap workspace and logs
      - name: "Debug: Post-bootstrap workspace & multibuild logs"
        shell: powershell
        run: |
          Write-Host "Listing workspace after bootstrap (top-level)..."
          Get-ChildItem -Force | Select-Object -First 200 | Format-Table -AutoSize

          Write-Host "Listing camoufox-* directories (if any):"
          Get-ChildItem -Directory "camoufox-*" -ErrorAction SilentlyContinue | Format-Table -AutoSize

          Write-Host "Direct multibuild tail (if present):"
          if (Test-Path multibuild_download_direct.log) { Get-Content multibuild_download_direct.log -Tail 200 } else { Write-Host "No multibuild_download_direct.log found" }

          Write-Host "Start-shell multibuild tail (if present):"
          if (Test-Path multibuild_inner.log) { Get-Content multibuild_inner.log -Tail 200 } else { Write-Host "No multibuild_inner.log found" }

          Write-Host "Mach bootstrap tail (if present):"
          if (Test-Path multibuild_bootstrap_inner.log) { Get-Content multibuild_bootstrap_inner.log -Tail 400 } else { Write-Host "No multibuild_bootstrap_inner.log found" }

      # VERIFY: Ensure multibuild created a camoufox-* directory
      - name: Verify Source Directory
        shell: powershell
        run: |
          $SourceDir = Get-ChildItem -Directory "camoufox-*" | Select-Object -First 1 -ExpandProperty Name
          if (-not $SourceDir) { Write-Host "ERROR: No camoufox-* directory found; multibuild.py setup or bootstrap may have failed."; exit 1 }
          Write-Host "Detected SOURCE DIRECTORY: $SourceDir"

      # 6. INJECT SOVEREIGN CODE (PHASE 4 & 5)
      # Injects the Python logic into the browser's internal engine
      - name: Inject Sovereign Code
        shell: powershell
        run: |
          # Dynamic Source Directory Detection (Handles camoufox-115/128 etc)
          $SourceDir = Get-ChildItem -Directory "camoufox-*" | Select-Object -First 1 -ExpandProperty Name
          Write-Host "TARGET SOURCE DIRECTORY: $SourceDir"
          
          # --- PHASE 4: GENESIS & COMMERCE ---
          if (Test-Path "core/genesis_engine.py") {
             Copy-Item "core/genesis_engine.py" -Destination "$SourceDir/python/mozbuild/mozbuild/" -Force
             Write-Host "Injecting Genesis Engine... OK"
          }
          if (Test-Path "modules/commerce_injector.py") {
             Copy-Item "modules/commerce_injector.py" -Destination "$SourceDir/python/mozbuild/mozbuild/" -Force
             Write-Host "Injecting Commerce Injector... OK"
          }
          
          # --- PHASE 5: SOVEREIGN BIOMETRICS ---
          if (Test-Path "modules/humanization.py") {
            Copy-Item "modules/humanization.py" -Destination "$SourceDir/python/mozbuild/mozbuild/" -Force
            Write-Host "Injecting Phase 5 Biometrics... OK"
          }

      # 7. CONFIGURE BUILD OPTIONS (.mozconfig)
      - name: Configure MozConfig
        shell: cmd
        run: |
          cd camoufox-*
          echo Configuring Build Options...
          
          REM --- ARCHITECTURE ---
          call "C:\mozilla-build\start-shell.bat" -c "echo 'ac_add_options --target=x86_64-pc-windows-msvc' >> .mozconfig"
          
          REM --- TELEMETRY & REPORTING (STRICT) ---
          REM NOTE: --disable-telemetry is deprecated and breaks builds. Using specific disablers instead.
          call "C:\mozilla-build\start-shell.bat" -c "echo 'ac_add_options --disable-crashreporter' >> .mozconfig"
          call "C:\mozilla-build\start-shell.bat" -c "echo 'ac_add_options --disable-maintenance-service' >> .mozconfig"
          call "C:\mozilla-build\start-shell.bat" -c "echo 'ac_add_options --disable-updater' >> .mozconfig"
          
          REM --- OPTIMIZATION ---
          call "C:\mozilla-build\start-shell.bat" -c "echo 'ac_add_options --disable-tests' >> .mozconfig"
          call "C:\mozilla-build\start-shell.bat" -c "echo 'ac_add_options --disable-debug' >> .mozconfig"
          call "C:\mozilla-build\start-shell.bat" -c "echo 'ac_add_options --enable-optimize' >> .mozconfig"

      # 8. COMPILE (The Long Step)
      - name: Compile Binary
        shell: cmd
        timeout-minutes: 360 # 6 Hours Max
        run: |
          cd camoufox-*
          call "C:\mozilla-build\start-shell.bat" -c "./mach build"

      # 9. PACKAGE INSTALLER
      - name: Package Release
        shell: cmd
        run: |
          cd camoufox-*
          call "C:\mozilla-build\start-shell.bat" -c "./mach package"

      # 10. VERIFY PACKAGING + UPLOAD ARTIFACT
      - name: Verify Packages
        shell: powershell
        run: |
          $zips = Get-ChildItem -Path "camoufox-*/obj-*/dist/install/sea/*.zip" -File -ErrorAction SilentlyContinue
          if (-not $zips) {
            Write-Host "ERROR: No packaged installers found at camoufox-*/obj-*/dist/install/sea/*.zip"
            Write-Host "Dumping diagnostic logs for review..."
            if (Test-Path multibuild_download_direct.log) { Get-Content multibuild_download_direct.log -Raw } else { Write-Host "No multibuild_download_direct.log found" }
            if (Test-Path multibuild_inner.log) { Get-Content multibuild_inner.log -Raw } else { Write-Host "No multibuild_inner.log found" }
            if (Test-Path multibuild_bootstrap_inner.log) { Get-Content multibuild_bootstrap_inner.log -Raw } else { Write-Host "No multibuild_bootstrap_inner.log found" }
            exit 1
          } else {
            Write-Host "Found packaged installers: $($zips.Name -join ', ')"
          }

      - name: Upload Build Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lucid-build-logs
          path: |
            multibuild_download_direct.log
            multibuild_inner.log
            multibuild_bootstrap_inner.log
            choco_mozillabuild_install.log
          if-no-files-found: warn

      - name: Upload Lucid Binary
        uses: actions/upload-artifact@v4
        with:
          name: lucid-empire-release
          path: camoufox-*/obj-*/dist/install/sea/*.zip
          retention-days: 5
          if-no-files-found: error
