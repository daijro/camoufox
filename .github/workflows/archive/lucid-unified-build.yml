name: Lucid Empire Unified Build (Phase 4+5)

on: [push, workflow_dispatch]

jobs:
  build:
    concurrency:
      group: 'lucid-unified-build-${{ github.ref }}'
      cancel-in-progress: false

    name: Build Camoufox Windows
    runs-on: windows-2022 # Upgraded from windows-2019 for runner availability
    
    env:
      MOZILLABUILD: C:\mozilla-build
      MOZ_OBJDIR: obj-lucid-release
      # Phase 5: Ensure strict mode is set for compiler
      LUCID_STRICT_MODE: 1

    steps:
      # 1. CHECKOUT REPOSITORY
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      # DEBUG: List workspace to assist with transient failures
      - name: "Debug: Workspace contents"
        shell: powershell
        run: |
          Write-Host "Listing top-level workspace entries (limited)..."
          Get-ChildItem -Force | Select-Object -First 200 | Format-Table -AutoSize

      # 2. INSTALL BUILD PREREQUISITES
      - name: Install Build Prerequisites
        shell: powershell
        run: |
          choco install make aria2 7zip wget -y --no-progress
          Write-Host "Attempting optional package: msitools (may not be available on Chocolatey)"
          try { choco install msitools -y --no-progress } catch { Write-Host "msitools not available via Chocolatey; skipping..." }

      # 3. INSTALL MOZILLABUILD
      - name: Install MozillaBuild Environment (retries + debug logs)
        shell: powershell
        run: |
          choco feature enable -n allowGlobalConfirmation || true
          Write-Host "Chocolatey version:"; choco --version
          Write-Host "Searching for mozillabuild package..."; choco search mozillabuild || true

          $installed = $false
          for ($i=1; $i -le 3; $i++) {
            Write-Host "Attempt #${i}: installing mozillabuild (4.4.0)"
            try {
              choco install mozillabuild --version=4.4.0 -y --no-progress --debug | Tee-Object -FilePath choco_mozillabuild_install.log
              $installed = $true
              break
            } catch {
              Write-Host "Attempt #${i} failed: $_"
              Start-Sleep -Seconds (5 * $i)
            }
          }

          if (-not $installed) {
            Write-Host "Versioned install failed; trying unversioned install"
            try { choco install mozillabuild -y --no-progress --debug | Tee-Object -FilePath choco_mozillabuild_install.log; $installed = $true } catch { Write-Host "Unversioned install failed: $_" }
          }

          if (-not $installed) {
            Write-Host "ERROR: mozillabuild could not be installed via Chocolatey."
            Write-Host "choco search mozillabuild output:"; choco search mozillabuild || true
            Write-Host "Listing local packages:"; choco list --local-only || true
            Write-Host "Contents of choco_mozillabuild_install.log:"; if (Test-Path choco_mozillabuild_install.log) { Get-Content choco_mozillabuild_install.log -Tail 200 } else { Write-Host "No choco log found" }
            exit 1
          }
          Write-Host "mozillabuild installed successfully."
      
      # 4. SET GIT IDENTITY (Required for Patching)
      - name: Configure Git Identity
        run: |
          git config --global user.email "ci-bot@lucid.empire"
          git config --global user.name "Lucid Builder"

      # 5. BOOTSTRAP SOURCE CODE
      - name: Start-Shell Pre-Bootstrap Diagnostic
        shell: cmd
        run: |
          echo "STARTING START-SHELL DIAGNOSTIC..."
          call "C:\mozilla-build\start-shell.bat" -c "echo PATH: $PATH; which aria2c || echo 'aria2c MISSING'; which make || echo 'make MISSING'; which 7z || echo '7z MISSING'; python3 --version || echo 'python3 MISSING'; make -n bootstrap" > multibuild_dryrun.log 2>&1

      - name: Attempt Start-Shell Multibuild (internal logging)
        continue-on-error: true
        shell: cmd
        run: |
          echo "ATTEMPT: multibuild inside start-shell (captures output to multibuild_inner.log)"
          call "C:\mozilla-build\start-shell.bat" -c "python -u multibuild.py --bootstrap --target windows --arch x86_64" > multibuild_inner.log 2>&1 || echo "START_SHELL_FAILED" >> multibuild_inner.log || true

      - name: Attempt Direct Multibuild (runner)
        if: runner.os != 'Windows'
        continue-on-error: true
        shell: cmd
        run: |
          echo "ATTEMPT: Direct multibuild on runner (captures output to multibuild_download_direct.log)"
          python -u multibuild.py --bootstrap --target windows --arch x86_64 > multibuild_download_direct.log 2>&1 || echo "DIRECT_RUN_FAILED" >> multibuild_download_direct.log || true

      - name: Bootstrap Source
        continue-on-error: true
        shell: cmd
        run: |
          echo "ATTEMPT: mach bootstrap inside start-shell (captures output to multibuild_bootstrap_inner.log)"
          call "C:\mozilla-build\start-shell.bat" -c "./mach bootstrap --application-choice=browser --no-interactive" > multibuild_bootstrap_inner.log 2>&1 || echo "MACH_BOOTSTRAP_FAILED" >> multibuild_bootstrap_inner.log || true

      # DEBUG: Post-bootstrap workspace and logs
      - name: "Debug: Post-bootstrap workspace & multibuild logs"
        shell: powershell
        run: |
          Write-Host "Listing workspace after bootstrap (top-level)..."
          Get-ChildItem -Force | Select-Object -First 200 | Format-Table -AutoSize

          Write-Host "Listing camoufox-* directories (if any):"
          Get-ChildItem -Directory "camoufox-*" -ErrorAction SilentlyContinue | Format-Table -AutoSize

          Write-Host "--- multibuild_inner.log ---"
          if (Test-Path multibuild_inner.log) { Get-Content multibuild_inner.log -Tail 200 } else { Write-Host "No multibuild_inner.log found" }

          Write-Host "--- multibuild_bootstrap_inner.log ---"
          if (Test-Path multibuild_bootstrap_inner.log) { Get-Content multibuild_bootstrap_inner.log -Tail 400 } else { Write-Host "No multibuild_bootstrap_inner.log found" }

          Write-Host "--- multibuild_download_direct.log ---"
          if (Test-Path multibuild_download_direct.log) { Get-Content multibuild_download_direct.log -Tail 200 } else { Write-Host "No multibuild_download_direct.log found" }

          Write-Host "--- multibuild_dryrun.log ---"
          if (Test-Path multibuild_dryrun.log) { Get-Content multibuild_dryrun.log -Tail 200 } else { Write-Host "No multibuild_dryrun.log found" }

      # VERIFY: Ensure multibuild created a camoufox-* directory
      - name: Verify Source Directory
        shell: powershell
        run: |
          # Try top-level first, then search recursively if not found
          $SourceDir = Get-ChildItem -Directory "camoufox-*" -ErrorAction SilentlyContinue | Select-Object -First 1 -ExpandProperty Name
          if (-not $SourceDir) {
            $recursive = Get-ChildItem -Recurse -Directory -ErrorAction SilentlyContinue | Where-Object { $_.Name -like 'camoufox-*' } | Select-Object -First 1
            if ($recursive) { $SourceDir = $recursive.FullName }
          }

          if ($SourceDir) {
            Write-Host "Detected SOURCE DIRECTORY: $SourceDir"
          } else {
            Write-Host "ERROR: No camoufox-* directory found; multibuild.py setup or bootstrap may have failed."
            Write-Host "Listing workspace top-level (limited):"
            Get-ChildItem -Force | Select-Object -First 200 | Format-Table -AutoSize
            Write-Host "Looking for camoufox-* recursively (depth unlimited):"
            Get-ChildItem -Recurse -Directory -ErrorAction SilentlyContinue | Where-Object { $_.Name -like 'camoufox-*' } | Format-Table -AutoSize

            Write-Host "--- multibuild logs (if present) ---"
            if (Test-Path multibuild_download_direct.log) { Get-Content multibuild_download_direct.log -Raw } else { Write-Host "No multibuild_download_direct.log found" }
            if (Test-Path multibuild_inner.log) { Get-Content multibuild_inner.log -Raw } else { Write-Host "No multibuild_inner.log found" }
            if (Test-Path multibuild_bootstrap_inner.log) { Get-Content multibuild_bootstrap_inner.log -Raw } else { Write-Host "No multibuild_bootstrap_inner.log found" }
            exit 1
          }

      # 6. INJECT LUCID MODIFICATIONS (PHASE 4 & 5)
      - name: Inject Sovereign Code
        shell: powershell
        run: |
          $SourceDir = Get-ChildItem -Directory "camoufox-*" | Select-Object -First 1 -ExpandProperty Name
          Write-Host "TARGET SOURCE DIRECTORY: $SourceDir"
          # --- PHASE 4 INJECTIONS ---
          Copy-Item "core/genesis_engine.py" -Destination "$SourceDir/python/mozbuild/mozbuild/" -Force
          Copy-Item "modules/commerce_injector.py" -Destination "$SourceDir/python/mozbuild/mozbuild/" -Force
          # --- PHASE 5 INJECTIONS (SOVEREIGNTY) ---
          if (Test-Path "modules/humanization.py") {
            Copy-Item "modules/humanization.py" -Destination "$SourceDir/python/mozbuild/mozbuild/" -Force
          }
          if (Test-Path "network/xdp_outbound.c") {
            New-Item -ItemType Directory -Force -Path "$SourceDir/distribution/extensions"
            Copy-Item "network/xdp_outbound.c" -Destination "$SourceDir/distribution/extensions/" -Force
          }

      # 7. CONFIGURE BUILD OPTIONS (.mozconfig)
      - name: Configure MozConfig
        shell: cmd
        run: |
          cd camoufox-*
          call "C:\mozilla-build\start-shell.bat" -c "echo 'ac_add_options --target=x86_64-pc-windows-msvc' >> .mozconfig"
          REM call "C:\mozilla-build\start-shell.bat" -c "echo 'ac_add_options --disable-telemetry' >> .mozconfig"   REMOVED for compatibility
          call "C:\mozilla-build\start-shell.bat" -c "echo 'ac_add_options --disable-tests' >> .mozconfig"
          call "C:\mozilla-build\start-shell.bat" -c "echo 'ac_add_options --disable-debug' >> .mozconfig"
          call "C:\mozilla-build\start-shell.bat" -c "echo 'ac_add_options --enable-optimize' >> .mozconfig"

      # 8. COMPILE (THE BUILD)
      - name: Compile Binary
        shell: cmd
        timeout-minutes: 360
        run: |
          cd camoufox-*
          call "C:\mozilla-build\start-shell.bat" -c "./mach build"

      # 9. PACKAGE INSTALLER
      - name: Package Release
        shell: cmd
        run: |
          cd camoufox-*
          call "C:\mozilla-build\start-shell.bat" -c "./mach package"

      # 10. VERIFY PACKAGING + UPLOAD ARTIFACT
      - name: Verify Packages
        shell: powershell
        run: |
          $zips = Get-ChildItem -Path "camoufox-*/obj-*/dist/install/sea/*.zip" -File -ErrorAction SilentlyContinue
          if (-not $zips) {
            Write-Host "ERROR: No packaged installers found at camoufox-*/obj-*/dist/install/sea/*.zip"
            Write-Host "Dumping diagnostic logs for review..."
            if (Test-Path multibuild_download_direct.log) { Get-Content multibuild_download_direct.log -Raw } else { Write-Host "No multibuild_download_direct.log found" }
            if (Test-Path multibuild_inner.log) { Get-Content multibuild_inner.log -Raw } else { Write-Host "No multibuild_inner.log found" }
            if (Test-Path multibuild_bootstrap_inner.log) { Get-Content multibuild_bootstrap_inner.log -Raw } else { Write-Host "No multibuild_bootstrap_inner.log found" }
            exit 1
          } else {
            Write-Host "Found packaged installers: $($zips.Name -join ', ')"
          }

      - name: Upload Build Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lucid-build-logs
          path: |
            multibuild_download_direct.log
            multibuild_inner.log
            multibuild_bootstrap_inner.log
            choco_mozillabuild_install.log
          if-no-files-found: warn

      - name: Harvest Lucid Binary
        uses: actions/upload-artifact@v4
        with:
          name: lucid-empire-phase5-release
          path: camoufox-*/obj-*/dist/install/sea/*.zip
          retention-days: 7
          if-no-files-found: error
