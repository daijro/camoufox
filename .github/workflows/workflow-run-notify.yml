name: Notify on Windows Build Completion

on:
  workflow_run:
    workflows: [ "Lucid Windows Native Build" ]
    types: [ completed ]

permissions:
  issues: write
  actions: read

jobs:
  notify:
    name: Notify PRs about Windows build result
    runs-on: ubuntu-latest
    steps:
      - name: Notify via GitHub Script
        uses: actions/github-script@v6
        with:
          script: |
            const run = context.payload.workflow_run;
            const conclusion = run.conclusion || 'unknown';
            const branch = run.head_branch || 'unknown';
            const runUrl = run.html_url || `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${run.id}`;

            // Gather artifacts for the run
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: run.id,
            });

            const artifactList = artifacts.data.artifacts.map(a => `- ${a.name}`).join('\n') || 'None';

            const body = `**Workflow \`${run.name}\` completed**\n\n- **Conclusion**: ${conclusion}\n- **Branch**: ${branch}\n- **Run**: ${runUrl}\n- **Artifacts:**\n${artifactList}\n\n_This comment was created automatically by the CI monitor workflow._`;

            // Find open PRs that match the branch
            const prs = await github.rest.pulls.list({ owner: context.repo.owner, repo: context.repo.repo, head: `${context.repo.owner}:${branch}`, state: 'open' });

            if (prs.data.length === 0) {
              core.info(`No open PR found for branch ${branch}; not posting a PR comment.`);
            } else {
              for (const pr of prs.data) {
                await github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: pr.number, body });
                core.info(`Posted comment to PR #${pr.number}`);
              }
            }

            // --- Additional: create an issue if there are N consecutive failures ---
            const FAILURE_THRESHOLD = 3;
            if (conclusion === 'failure') {
              // List recent workflow runs for this repository and branch
              const recentRuns = await github.rest.actions.listWorkflowRunsForRepo({ owner: context.repo.owner, repo: context.repo.repo, branch: branch, per_page: 20 });
              const relevant = recentRuns.data.workflow_runs.filter(r => r.name === run.name).sort((a,b) => new Date(b.created_at) - new Date(a.created_at));

              // Count consecutive failures from the most recent run
              let failureCount = 0;
              for (const r of relevant) {
                if (r.conclusion === 'failure') { failureCount++; } else { break; }
              }

              core.info(`Detected ${failureCount} consecutive failures for workflow ${run.name} on branch ${branch}`);

              if (failureCount >= FAILURE_THRESHOLD) {
                // Avoid duplicate issues: check open issues that mention the workflow and branch
                const issues = await github.rest.issues.listForRepo({ owner: context.repo.owner, repo: context.repo.repo, state: 'open', per_page: 100 });
                const title = `[CI] ${run.name} failed ${failureCount} times in a row on branch ${branch}`;
                const existing = issues.data.find(i => i.title && i.title.includes(`${run.name}`) && i.title.includes(branch));
                if (existing) {
                  // Comment on existing issue
                  await github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: existing.number, body: `Build ${runUrl} failed again (current count: ${failureCount}). See run details and artifacts: ${runUrl}` });
                  core.info(`Commented on existing issue #${existing.number}`);
                } else {
                  // Create a new issue summarizing the problem
                  const issueBody = `The **${run.name}** workflow has failed **${failureCount}** consecutive times on branch **${branch}**.\n\nLatest run: ${runUrl}\n\nArtifacts:\n${artifactList}\n\n**Remediation checklist (start here):**\n- [ ] Review \`multibuild_inner.log\` and \`multibuild_bootstrap_inner.log\` artifacts for errors and stack traces\n- [ ] Review any attached Chocolatey/multibuild logs for install failures\n- [ ] Confirm that **mozillabuild** and required dependencies (Python, Rust, make, aria2, 7zip) are present on the runner\n- [ ] Check that a \`camoufox-*\` source directory was created in the workspace\n- [ ] Ensure that no Linux-only package manager commands (apt/dnf/pacman) were invoked on Windows\n- [ ] Consider using a pre-built bootstrap artifact or a self-hosted Windows runner with dependencies preinstalled\n\nPlease investigate the failure and see attached logs. (See PR_NOTES/DIAGNOSTICS_ADDED.md for guidance)`;
                  const newIssue = await github.rest.issues.create({ owner: context.repo.owner, repo: context.repo.repo, title: title, body: issueBody });
                  core.info(`Created issue #${newIssue.data.number} for repeated failures`);
                }
              }
            }
