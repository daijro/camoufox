name: Windows Build (Phases 4 & 5)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    concurrency:
      group: 'windows-build-${{ github.ref }}'
      cancel-in-progress: false

    runs-on: windows-latest
    env:
      INSTALL_MSVC: 'false'  # Set to 'true' to enable MSVC toolchain installation on the runner
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # PHASE 4: CORE BUILD
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install Build Tools
        shell: pwsh
        run: |
          choco feature enable -n allowGlobalConfirmation || true
          Write-Host "Chocolatey version:"; choco --version
          choco install make aria2 7zip wget -y || true
          Write-Host "Attempting optional package: msitools (may not be available via Chocolatey)"
          try { choco install msitools -y || true } catch { Write-Host "msitools not available via Chocolatey; skipping..." }

      - name: Install MozillaBuild (retries + debug logs)
        shell: pwsh
        run: |
          Write-Host "Searching for mozillabuild package..."; choco search mozillabuild || true
          $installed = $false
          for ($i=1; $i -le 3; $i++) {
            Write-Host "Attempt #$i: installing mozillabuild (4.4.0)"
            try { choco install mozillabuild --version=4.4.0 -y --no-progress --debug | Tee-Object -FilePath choco_mozillabuild_install.log; $installed=$true; break } catch { Write-Host "Attempt #$i failed: $_" ; Start-Sleep -Seconds (5 * $i) }
          }
          if (-not $installed) {
            Write-Host "Versioned install failed; trying unversioned install"
            try { choco install mozillabuild -y --no-progress --debug | Tee-Object -FilePath choco_mozillabuild_install.log; $installed=$true } catch { Write-Host "Unversioned install failed: $_" }
          }
          if (-not $installed) {
            Write-Host "ERROR: mozillabuild could not be installed via Chocolatey."
            choco search mozillabuild || true
            choco list --local-only || true
            if (Test-Path choco_mozillabuild_install.log) { Get-Content choco_mozillabuild_install.log -Tail 200 }
            exit 1
          }
          Write-Host "mozillabuild installed successfully."

      - name: Install MSVC (optional)
        if: ${{ env.INSTALL_MSVC == 'true' }}
        shell: pwsh
        run: |
          # Optional: install Visual Studio Build Tools. Commented / gated by INSTALL_MSVC env.
          choco install visualstudio2022buildtools --package-parameters "--add Microsoft.VisualStudio.Component.VC.Tools.x86.x64 --quiet" -y || true

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build Lucid
        shell: pwsh
        run: |
          # Clean then build
          python multibuild.py --target windows --arch x86_64 --clean || true
          python multibuild.py --target windows --arch x86_64

      # PHASE 5: VALIDATION
      - name: Verify GAN Model
        run: python -c "import onnxruntime; print('GAN Model Loaded')"

      - name: Test GeoIP
        run: python -c "from geoip2 import database; print('GeoIP2 Verified')"

      - name: Package Artifacts
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path artifacts
          if (Test-Path 'bin\\lucid.exe') { Copy-Item 'bin\\lucid.exe' artifacts -Force } else { Write-Host 'Missing: bin\\lucid.exe' }
          if (Test-Path 'genesis\\docker-compose.yml') { Copy-Item 'genesis\\docker-compose.yml' artifacts -Force } else { Write-Host 'Missing: genesis\\docker-compose.yml' }
          if (Test-Path 'network\\xdp_outbound.c') { Copy-Item 'network\\xdp_outbound.c' artifacts -Force } else { Write-Host 'Missing: network\\xdp_outbound.c' }

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: lucid-build
          path: artifacts/*
