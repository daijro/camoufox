name: Lucid Empire Unified Build (Phase 4+5)

on: [push, workflow_dispatch]

jobs:
  build:
    concurrency:
      group: 'lucid-unified-build-${{ github.ref }}'
      cancel-in-progress: false

    name: Build Camoufox Windows
    runs-on: windows-2019 # Critical: Pinned for MSVC compatibility
    
    env:
      MOZILLABUILD: C:\mozilla-build
      MOZ_OBJDIR: obj-lucid-release
      # Phase 5: Ensure strict mode is set for compiler
      LUCID_STRICT_MODE: 1

    steps:
      # 1. CHECKOUT REPOSITORY
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      # 2. INSTALL BUILD PREREQUISITES
      - name: Install Build Prerequisites
        shell: powershell
        run: |
          choco install make aria2 7zip wget -y --no-progress
          Write-Host "Attempting optional package: msitools (may not be available on Chocolatey)"
          try { choco install msitools -y --no-progress } catch { Write-Host "msitools not available via Chocolatey; skipping..." }

      # 3. INSTALL MOZILLABUILD
      - name: Install MozillaBuild Environment (retries + debug logs)
        shell: powershell
        run: |
          choco feature enable -n allowGlobalConfirmation || true
          Write-Host "Chocolatey version:"; choco --version
          Write-Host "Searching for mozillabuild package..."; choco search mozillabuild || true

          $installed = $false
          for ($i=1; $i -le 3; $i++) {
            Write-Host "Attempt #$i: installing mozillabuild (4.4.0)"
            try {
              choco install mozillabuild --version=4.4.0 -y --no-progress --debug | Tee-Object -FilePath choco_mozillabuild_install.log
              $installed = $true
              break
            } catch {
              Write-Host "Attempt #$i failed: $_"
              Start-Sleep -Seconds (5 * $i)
            }
          }

          if (-not $installed) {
            Write-Host "Versioned install failed; trying unversioned install"
            try { choco install mozillabuild -y --no-progress --debug | Tee-Object -FilePath choco_mozillabuild_install.log; $installed = $true } catch { Write-Host "Unversioned install failed: $_" }
          }

          if (-not $installed) {
            Write-Host "ERROR: mozillabuild could not be installed via Chocolatey."
            Write-Host "choco search mozillabuild output:"; choco search mozillabuild || true
            Write-Host "Listing local packages:"; choco list --local-only || true
            Write-Host "Contents of choco_mozillabuild_install.log:"; if (Test-Path choco_mozillabuild_install.log) { Get-Content choco_mozillabuild_install.log -Tail 200 } else { Write-Host "No choco log found" }
            exit 1
          }
          Write-Host "mozillabuild installed successfully."
      
      # 4. SET GIT IDENTITY (Required for Patching)
      - name: Configure Git Identity
        run: |
          git config --global user.email "ci-bot@lucid.empire"
          git config --global user.name "Lucid Builder"

      # 5. BOOTSTRAP SOURCE CODE
      - name: Bootstrap Source
        shell: cmd
        run: |
          call "C:\mozilla-build\start-shell.bat" -c "./mach bootstrap --application-choice=browser --no-interactive"

      # 6. INJECT LUCID MODIFICATIONS (PHASE 4 & 5)
      - name: Inject Sovereign Code
        shell: powershell
        run: |
          $SourceDir = Get-ChildItem -Directory "camoufox-*" | Select-Object -First 1 -ExpandProperty Name
          Write-Host "TARGET SOURCE DIRECTORY: $SourceDir"
          # --- PHASE 4 INJECTIONS ---
          Copy-Item "core/genesis_engine.py" -Destination "$SourceDir/python/mozbuild/mozbuild/" -Force
          Copy-Item "modules/commerce_injector.py" -Destination "$SourceDir/python/mozbuild/mozbuild/" -Force
          # --- PHASE 5 INJECTIONS (SOVEREIGNTY) ---
          if (Test-Path "modules/humanization.py") {
            Copy-Item "modules/humanization.py" -Destination "$SourceDir/python/mozbuild/mozbuild/" -Force
          }
          if (Test-Path "network/xdp_outbound.c") {
            New-Item -ItemType Directory -Force -Path "$SourceDir/distribution/extensions"
            Copy-Item "network/xdp_outbound.c" -Destination "$SourceDir/distribution/extensions/" -Force
          }

      # 7. CONFIGURE BUILD OPTIONS (.mozconfig)
      - name: Configure MozConfig
        shell: cmd
        run: |
          cd camoufox-*
          call "C:\mozilla-build\start-shell.bat" -c "echo 'ac_add_options --target=x86_64-pc-windows-msvc' >> .mozconfig"
          REM call "C:\mozilla-build\start-shell.bat" -c "echo 'ac_add_options --disable-telemetry' >> .mozconfig"   REMOVED for compatibility
          call "C:\mozilla-build\start-shell.bat" -c "echo 'ac_add_options --disable-tests' >> .mozconfig"
          call "C:\mozilla-build\start-shell.bat" -c "echo 'ac_add_options --disable-debug' >> .mozconfig"
          call "C:\mozilla-build\start-shell.bat" -c "echo 'ac_add_options --enable-optimize' >> .mozconfig"

      # 8. COMPILE (THE BUILD)
      - name: Compile Binary
        shell: cmd
        timeout-minutes: 360
        run: |
          cd camoufox-*
          call "C:\mozilla-build\start-shell.bat" -c "./mach build"

      # 9. PACKAGE INSTALLER
      - name: Package Release
        shell: cmd
        run: |
          cd camoufox-*
          call "C:\mozilla-build\start-shell.bat" -c "./mach package"

      # 10. UPLOAD ARTIFACT (THE FINAL EXE)
      - name: Harvest Lucid Binary
        uses: actions/upload-artifact@v4
        with:
          name: lucid-empire-phase5-release
          path: camoufox-*/obj-*/dist/install/sea/*.zip
          retention-days: 7
